# This file contains common pin mappings for the 2017 Creality
# CR-10. To use this config, the firmware should be compiled for the
# AVR atmega1284p.

# Note, a number of Melzi boards are shipped with a bootloader that
# requires the following command to flash the board:
#  avrdude -p atmega1284p -c arduino -b 57600 -P /dev/ttyUSB0 -U out/klipper.elf.hex
# If the above command does not work and "make flash" does not work
# then one may need to flash a bootloader to the board - see the
# Klipper docs/Bootloaders.md file for more information.

# See docs/Config_Reference.md for a description of parameters.
#
### Input Shaper ###
#[include lis2dw.cfg]
[input_shaper]
#shaper_type_x = mzv
#shaper_freq_x = 0
#shaper_type_y = mzv
#shaper_freq_y = 0


[stepper_x]
step_pin: PD7
dir_pin: !PC5
enable_pin: !PD6
microsteps: 16
rotation_distance: 40 
endstop_pin: ^PC2
position_endstop: 0
position_max: 312
homing_speed: 50

[stepper_y] 
step_pin: PC6
dir_pin: !PC7
enable_pin: !PD6
microsteps: 16
rotation_distance: 40
endstop_pin: ^PC3
position_endstop: 0
position_max: 300
homing_speed: 50

[stepper_z]
step_pin: PB3
dir_pin: PB2
enable_pin: !PA5
microsteps: 16
rotation_distance: 8
#endstop_pin: ^PC4
#position_endstop: 0.0
endstop_pin: probe:z_virtual_endstop    # enable to use BLTouch
position_min: -5                        # enable to use BLTouch
position_max: 400

[safe_z_home]                         # enable for BLTouch
home_xy_position: 195, 160
speed: 100
z_hop: 10
z_hop_speed: 5

[bltouch]                             # enable for BLTouch - fast-mode
sensor_pin: ^PC4
control_pin: PA4
pin_up_touch_mode_reports_triggered: True
probe_with_touch_mode: True
x_offset: -45                          # modify as needed for bltouch location
y_offset: -10                          # modify as needed for bltouch location
#z_offset: 0.0                         # modify as needed for bltouch or run PROBE_CALIBRATE
speed: 10
samples: 3
sample_retract_dist: 2.5              # Can be set lower, example 2.5 depending on height of bltouch from bed
lift_speed: 50
samples_tolerance_retries: 3
speed: 10
samples: 2

[bed_mesh]                            # enable for BLTouch
speed: 300
mesh_min:30, 30
mesh_max: 265, 265
algorithm: bicubic
probe_count: 11                       # 49 points due to large bed size
horizontal_move_z: 5


[gcode_macro G29]                     # If moving from marlin to klipper uncomment to mimic G29
gcode:
  BED_MESH_CALIBRATE ADAPTIVE=1
  G1 X0 Y0 Z10 F4000

[extruder]
step_pin: PB1
dir_pin: !PB0
enable_pin: !PD6
microsteps: 16
rotation_distance: 33.683
nozzle_diameter: 0.8
filament_diameter: 1.750
heater_pin: PD5
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA7
#control: pid
#pid_Kp: 22.57
#pid_Ki: 1.72
#pid_Kd: 73.96
min_temp: 0
max_temp: 250

[heater_bed]
heater_pin: PD4
sensor_type: ATC Semitec 104GT-2
sensor_pin: PA6
#control: pid
#pid_Kp: 426.68
#pid_Ki: 78.92
#pid_Kd: 576.71
min_temp: 0
max_temp: 130

[fan]
pin: PB4

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0

[exclude_object]

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 5000
max_z_velocity: 10
max_z_accel: 200

[display]
lcd_type: st7920
cs_pin: PA3
sclk_pin: PA1
sid_pin: PC1
encoder_pins: ^PD2, ^PD3
click_pin: ^!PC0

[include mainsail.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bltouch]
#*# z_offset = 1.413
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 24.719
#*# pid_ki = 1.258
#*# pid_kd = 121.434
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 67.769
#*# pid_ki = 0.707
#*# pid_kd = 1623.910
#*#
#*# [bed_mesh PEI T 3 10.11.25]
#*# version = 1
#*# points =
#*# 	0.298750, 0.280000, 0.230000, 0.180000, 0.163750, 0.161250, 0.145000, 0.181250, 0.221250, 0.253750, 0.323750
#*# 	0.137500, 0.113750, 0.086250, 0.043750, 0.042500, 0.051250, 0.046250, 0.087500, 0.158750, 0.206250, 0.275000
#*# 	0.076250, 0.028750, 0.015000, 0.037500, 0.022500, 0.012500, 0.036250, 0.050000, 0.072500, 0.121250, 0.155000
#*# 	0.005000, -0.032500, -0.045000, -0.078750, -0.095000, -0.056250, -0.073750, -0.021250, 0.027500, 0.035000, 0.103750
#*# 	-0.026250, -0.051250, -0.066250, -0.058750, -0.131250, -0.116250, -0.136250, -0.115000, -0.066250, -0.016250, 0.022500
#*# 	0.040000, -0.013750, -0.036250, -0.090000, -0.125000, -0.132500, -0.140000, -0.122500, -0.068750, -0.067500, -0.013750
#*# 	0.057500, 0.007500, -0.008750, -0.036250, -0.071250, -0.055000, -0.051250, -0.032500, 0.033750, 0.080000, 0.128750
#*# 	0.110000, 0.088750, 0.062500, 0.027500, -0.020000, -0.020000, -0.000000, -0.005000, 0.047500, 0.097500, 0.161250
#*# 	0.197500, 0.146250, 0.083750, 0.065000, 0.045000, 0.023750, 0.010000, 0.012500, 0.057500, 0.105000, 0.152500
#*# 	0.247500, 0.202500, 0.187500, 0.145000, 0.117500, 0.128750, 0.140000, 0.146250, 0.185000, 0.190000, 0.285000
#*# 	0.340000, 0.291250, 0.281250, 0.221250, 0.187500, 0.195000, 0.206250, 0.240000, 0.298750, 0.326250, 0.380000
#*# x_count = 11
#*# y_count = 11
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 265.0
#*# min_y = 30.0
#*# max_y = 265.0
#*#
#*# [bed_mesh PEI T 12.11.15]
#*# version = 1
#*# points =
#*# 	0.321250, 0.275000, 0.257500, 0.221250, 0.195000, 0.222500, 0.213750, 0.251250, 0.272500, 0.278750, 0.325000
#*# 	0.232500, 0.202500, 0.177500, 0.133750, 0.113750, 0.098750, 0.080000, 0.121250, 0.155000, 0.186250, 0.221250
#*# 	0.172500, 0.133750, 0.105000, 0.075000, 0.047500, 0.058750, 0.051250, 0.081250, 0.113750, 0.135000, 0.170000
#*# 	0.205000, 0.160000, 0.140000, 0.107500, 0.090000, 0.088750, 0.046250, 0.083750, 0.131250, 0.106250, 0.176250
#*# 	0.170000, 0.161250, 0.091250, 0.050000, 0.030000, 0.026250, 0.026250, 0.062500, 0.097500, 0.083750, 0.127500
#*# 	0.165000, 0.096250, 0.081250, 0.022500, -0.008750, -0.028750, -0.015000, -0.002500, 0.030000, 0.057500, 0.118750
#*# 	0.167500, 0.118750, 0.105000, 0.076250, 0.038750, 0.056250, 0.040000, 0.038750, 0.065000, 0.085000, 0.128750
#*# 	0.238750, 0.187500, 0.140000, 0.092500, 0.067500, 0.055000, 0.045000, 0.061250, 0.085000, 0.106250, 0.158750
#*# 	0.331250, 0.316250, 0.258750, 0.222500, 0.180000, 0.153750, 0.121250, 0.138750, 0.191250, 0.227500, 0.283750
#*# 	0.378750, 0.331250, 0.312500, 0.257500, 0.220000, 0.202500, 0.211250, 0.215000, 0.255000, 0.305000, 0.397500
#*# 	0.486250, 0.430000, 0.396250, 0.328750, 0.310000, 0.305000, 0.305000, 0.312500, 0.353750, 0.376250, 0.421250
#*# x_count = 11
#*# y_count = 11
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 265.0
#*# min_y = 30.0
#*# max_y = 265.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.207500, 0.212500, 0.220000, 0.217500, 0.226250, 0.267500, 0.262500, 0.313750, 0.362500, 0.385000, 0.428750
#*# 	0.101250, 0.118750, 0.121250, 0.091250, 0.120000, 0.152500, 0.110000, 0.188750, 0.246250, 0.273750, 0.327500
#*# 	0.028750, 0.023750, 0.038750, 0.023750, 0.030000, 0.046250, 0.063750, 0.102500, 0.127500, 0.176250, 0.228750
#*# 	-0.071250, -0.028750, -0.018750, -0.027500, -0.008750, 0.011250, 0.013750, 0.065000, 0.138750, 0.152500, 0.183750
#*# 	-0.050000, -0.037500, -0.030000, -0.037500, -0.051250, -0.038750, -0.045000, -0.015000, 0.030000, 0.042500, 0.072500
#*# 	-0.013750, -0.050000, -0.021250, -0.055000, -0.060000, -0.056250, -0.052500, -0.008750, 0.036250, 0.036250, 0.090000
#*# 	-0.051250, -0.002500, 0.001250, 0.015000, 0.016250, 0.017500, 0.042500, 0.060000, 0.103750, 0.098750, 0.166250
#*# 	0.017500, 0.028750, 0.016250, 0.016250, 0.016250, 0.017500, 0.036250, 0.040000, 0.096250, 0.096250, 0.157500
#*# 	0.057500, 0.072500, 0.047500, 0.068750, 0.062500, 0.065000, 0.050000, 0.105000, 0.120000, 0.141250, 0.261250
#*# 	0.131250, 0.152500, 0.138750, 0.146250, 0.151250, 0.175000, 0.176250, 0.211250, 0.260000, 0.281250, 0.330000
#*# 	0.277500, 0.266250, 0.247500, 0.232500, 0.228750, 0.240000, 0.223750, 0.257500, 0.291250, 0.320000, 0.368750
#*# x_count = 11
#*# y_count = 11
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 265.0
#*# min_y = 30.0
#*# max_y = 265.0
#*#
#*# [input_shaper]
#*# shaper_type_y = mzv
#*# shaper_freq_y = 27.0
#*# shaper_type_x = mzv
#*# shaper_freq_x = 78.2
